<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Chat - TheChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
  <header class="bg-cyan-500 text-white p-4 flex justify-between items-center">
    <button onclick="history.back()">â¬…</button>
    <h1 id="chatName"></h1>
  </header>
  <main id="messages" class="flex-1 overflow-y-auto p-4 space-y-2"></main>
  <footer class="p-4 bg-white flex gap-2">
    <input id="msgInput" class="flex-1 border rounded-lg px-3 py-2" placeholder="Ketik pesan...">
    <button id="sendBtn" class="bg-cyan-500 text-white px-4 py-2 rounded-lg">Kirim</button>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCG36zXHqQPCFNIda0s_QI6fOKszAQtZ0Y",
      authDomain: "thechat-b16c7.firebaseapp.com",
      projectId: "thechat-b16c7",
      storageBucket: "thechat-b16c7.firebasestorage.app",
      messagingSenderId: "562294284683",
      appId: "1:562294284683:web:ba118aa7de6a93a833cf8e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    const params = new URLSearchParams(window.location.search);
    const chatId = params.get("chatId");
    const receiverId = params.get("uid");
    const receiverName = params.get("name");
    document.getElementById("chatName").textContent = receiverName;

    const msgRef = collection(db, "messages", chatId, "chats");

    async function sendMessage() {
      const text = document.getElementById("msgInput").value.trim();
      if (!text) return;
      await addDoc(msgRef, {
        text,
        senderId: user.uid,
        receiverId,
        createdAt: new Date()
      });
      document.getElementById("msgInput").value = "";
    }

    document.getElementById("sendBtn").addEventListener("click", sendMessage);

    const q = query(msgRef, orderBy("createdAt"));
    onSnapshot(q, (snapshot) => {
      const container = document.getElementById("messages");
      container.innerHTML = "";
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = msg.senderId === user.uid ? "text-right" : "text-left";
        div.innerHTML = `<div class="inline-block px-3 py-2 rounded-lg ${msg.senderId === user.uid ? 'bg-cyan-500 text-white' : 'bg-gray-200'}">${msg.text}</div>`;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    });
  </script>
</body>
</html>
