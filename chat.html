<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - TheChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
  <header class="bg-cyan-500 text-white p-4 flex justify-between items-center shadow-lg">
    <button onclick="history.back()" class="text-xl font-bold p-1 rounded-full hover:bg-cyan-600 transition">â¬…</button>
    <h1 id="chatName" class="text-xl font-semibold truncate max-w-[70%]"></h1>
    <div></div> <!-- Placeholder for layout -->
  </header>
  <main id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></main>
  <footer class="p-3 bg-white flex gap-2 border-t shadow-inner">
    <input id="msgInput" class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="Ketik pesan..." onkeypress="if(event.key === 'Enter') document.getElementById('sendBtn').click()">
    <button id="sendBtn" class="bg-cyan-500 text-white px-5 py-2 rounded-full font-semibold hover:bg-cyan-600 transition">Kirim</button>
  </footer>

  <style>
    /* Styling tambahan untuk scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #999;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getMessaging, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCG36zXHqQPCFNIda0s_QI6fOKszAQtZ0Y",
      authDomain: "thechat-b16c7.firebaseapp.com",
      projectId: "thechat-b16c7",
      storageBucket: "thechat-b16c7.firebasestorage.app",
      messagingSenderId: "562294284683",
      appId: "1:562294284683:web:ba118aa7de6a93a833cf8e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Inisialisasi messaging untuk notifikasi foreground
    const messaging = getMessaging(app); 

    const LOGIN_PAGE = "index.html"; 

    const user = JSON.parse(localStorage.getItem("user"));
    
    // PENTING: Periksa apakah user ada
    if (!user || !user.uid) {
        console.error("Pengguna tidak terautentikasi atau data user tidak lengkap. Mengarahkan ke halaman login.");
        window.location.href = LOGIN_PAGE;
        // Hentikan eksekusi script lebih lanjut jika user tidak ada
        // return; 
    }

    const params = new URLSearchParams(window.location.search);
    const chatId = params.get("chatId");
    const receiverId = params.get("uid");
    const receiverName = params.get("name");
    
    // Pastikan parameter chat lengkap
    if (!chatId || !receiverId || !receiverName) {
        console.error("Parameter chat tidak lengkap. Kembali ke halaman kontak.");
        history.back();
        // return; 
    }

    document.getElementById("chatName").textContent = receiverName;

    // Path koleksi pesan
    const msgRef = collection(db, "messages", chatId, "chats");

    /**
     * Mengirim pesan baru ke Firestore.
     * DITAMBAHKAN: Blok try-catch untuk menangkap error saat addDoc.
     */
    async function sendMessage() {
      const msgInput = document.getElementById("msgInput");
      const text = msgInput.value.trim();
      if (!text) return;
      
      try {
          // Nonaktifkan tombol kirim sebentar untuk mencegah pengiriman ganda
          document.getElementById("sendBtn").disabled = true;

          await addDoc(msgRef, {
            text,
            senderId: user.uid,
            receiverId,
            createdAt: new Date()
          });
          
          msgInput.value = "";
          document.getElementById("sendBtn").disabled = false;
      } catch (error) {
          console.error("Error mengirim pesan ke Firestore:", error);
          document.getElementById("sendBtn").disabled = false;
          // Tampilkan pesan error sederhana ke pengguna (misalnya, di konsol atau UI)
          alert("Gagal mengirim pesan. Periksa koneksi atau konsol untuk detail.");
      }
    }

    document.getElementById("sendBtn").addEventListener("click", sendMessage);

    // Memungkinkan pengiriman pesan dengan tombol Enter
    document.getElementById("msgInput").addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Mencegah newline di input
            sendMessage();
        }
    });


    // 1. Listener Real-time untuk Pesan
    // Menggunakan orderBy("createdAt") harus didukung oleh indeks Firestore.
    const q = query(msgRef, orderBy("createdAt")); 
    
    onSnapshot(q, (snapshot) => {
      const container = document.getElementById("messages");
      // Hanya hapus dan render ulang jika ada perubahan dokumen
      // Menghapus elemen satu per satu lebih efisien, tapi ini cukup untuk saat ini.
      if (snapshot.docChanges().length > 0) { 
        container.innerHTML = ""; // Hapus pesan lama

        snapshot.forEach((doc) => {
          const msg = doc.data();
          const isSender = msg.senderId === user.uid;
          const div = document.createElement("div");
          
          // Styling bubble pesan
          const alignmentClass = isSender ? "text-right" : "text-left";
          const bubbleColor = isSender ? 'bg-cyan-500 text-white' : 'bg-gray-200 text-gray-800';

          div.className = alignmentClass;
          div.innerHTML = `
              <div class="inline-block px-4 py-2 rounded-xl max-w-xs break-words ${bubbleColor} shadow-md">
                  ${msg.text}
              </div>`;
          container.appendChild(div);
        });
        
        // Gulir ke bawah secara otomatis
        container.scrollTop = container.scrollHeight;
      }
    }, (error) => {
        // Penanganan error pada listener Firestore (misalnya, error izin/rules)
        console.error("Error pada real-time listener Firestore:", error);
        alert("Gagal memuat pesan. Periksa Firebase Security Rules Anda.");
    });
    
    // 2. Listener Notifikasi Foreground
    onMessage(messaging, (payload) => {
      console.log('Pesan Foreground Diterima:', payload);
      // Notifikasi di dalam aplikasi (jika diperlukan)
    });
  </script>
</body>
</html>
